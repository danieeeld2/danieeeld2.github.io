---
interface Props {
  projects: {
    title: string;
    items: {
      name: string;
      url: string;
      period: string;
      description: string;
      tags: string[];
    }[];
  };
}

const { projects } = Astro.props;
const allTags = [...new Set(projects.items.flatMap(p => p.tags))].sort();
const PAGE_SIZE = 6;
const totalPages = Math.ceil(projects.items.length / PAGE_SIZE);
---

<section id="projects" class="py-20 md:py-28">
  <div class="max-w-5xl mx-auto px-6">
    <h2 class="section-heading observe-fade">{projects.title}</h2>

    {/* Tag filters */}
    {allTags.length > 1 && (
      <div class="flex flex-wrap gap-2 mb-8 observe-fade" id="proj-filters">
        <button
          data-filter="all"
          class="ptag-filter tag cursor-pointer !bg-ink-900 !text-sand-50 dark:!bg-sand-200 dark:!text-ink-900"
        >
          All
        </button>
        {allTags.map((tag) => (
          <button data-filter={tag} class="ptag-filter tag cursor-pointer hover:bg-sand-300 dark:hover:bg-ink-700">
            {tag}
          </button>
        ))}
      </div>
    )}

    <div class="grid md:grid-cols-2 gap-6" id="proj-list">
      {projects.items.map((project, i) => (
        <a
          href={project.url}
          target="_blank"
          rel="noopener"
          class="card group observe-fade block proj-item"
          data-tags={project.tags.join(',')}
          data-index={i}
        >
          <div class="flex items-start justify-between mb-3">
            <h3 class="text-lg font-medium group-hover:text-sand-600 dark:group-hover:text-sand-400 transition-colors">{project.name}</h3>
            <svg class="w-4 h-4 text-ink-300 dark:text-sand-600 group-hover:translate-x-0.5 group-hover:-translate-y-0.5 transition-transform shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 17L17 7M17 7H7M17 7v10"/></svg>
          </div>
          <p class="text-sm font-mono text-ink-400 dark:text-sand-500 mb-3">{project.period}</p>
          <p class="text-ink-600 dark:text-sand-300 text-sm leading-relaxed mb-4">{project.description}</p>
          <div class="flex flex-wrap gap-2">
            {project.tags.map((tag) => (
              <span class="tag">{tag}</span>
            ))}
          </div>
        </a>
      ))}
    </div>

    {/* Pagination */}
    {totalPages > 1 && (
      <div class="flex items-center justify-center gap-4 mt-10" id="proj-pagination">
        <button id="proj-prev" class="text-sm font-mono px-4 py-2 rounded-full border border-sand-300 dark:border-ink-700 hover:bg-sand-200 dark:hover:bg-ink-800 transition-colors disabled:opacity-30 disabled:cursor-not-allowed">
          ←
        </button>
        <span id="proj-page-info" class="text-sm font-mono text-ink-400 dark:text-sand-500"></span>
        <button id="proj-next" class="text-sm font-mono px-4 py-2 rounded-full border border-sand-300 dark:border-ink-700 hover:bg-sand-200 dark:hover:bg-ink-800 transition-colors disabled:opacity-30 disabled:cursor-not-allowed">
          →
        </button>
      </div>
    )}
  </div>
</section>

<script is:inline define:vars={{ PAGE_SIZE }}>
(function() {
  const items = document.querySelectorAll('.proj-item');
  const filters = document.querySelectorAll('#proj-filters .ptag-filter');
  const pagination = document.getElementById('proj-pagination');
  const prevBtn = document.getElementById('proj-prev');
  const nextBtn = document.getElementById('proj-next');
  const pageInfo = document.getElementById('proj-page-info');

  if (!items.length) return;

  let activeTag = 'all';
  let currentPage = 0;

  function getVisible() {
    return [...items].filter(item => {
      if (activeTag === 'all') return true;
      return item.dataset.tags.split(',').includes(activeTag);
    });
  }

  function render() {
    const visible = getVisible();
    const pages = Math.ceil(visible.length / PAGE_SIZE);
    if (currentPage >= pages) currentPage = Math.max(0, pages - 1);

    items.forEach(item => item.style.display = 'none');
    visible.forEach((item, i) => {
      item.style.display = (i >= currentPage * PAGE_SIZE && i < (currentPage + 1) * PAGE_SIZE) ? '' : 'none';
    });

    if (pagination) {
      pagination.style.display = pages > 1 ? 'flex' : 'none';
      if (pageInfo) pageInfo.textContent = (currentPage + 1) + ' / ' + pages;
      if (prevBtn) prevBtn.disabled = currentPage === 0;
      if (nextBtn) nextBtn.disabled = currentPage >= pages - 1;
    }
  }

  filters.forEach(btn => {
    btn.addEventListener('click', () => {
      activeTag = btn.dataset.filter;
      currentPage = 0;
      filters.forEach(b => {
        b.classList.remove('!bg-ink-900', '!text-sand-50', 'dark:!bg-sand-200', 'dark:!text-ink-900');
      });
      btn.classList.add('!bg-ink-900', '!text-sand-50', 'dark:!bg-sand-200', 'dark:!text-ink-900');
      render();
    });
  });

  if (prevBtn) prevBtn.addEventListener('click', () => { currentPage--; render(); });
  if (nextBtn) nextBtn.addEventListener('click', () => { currentPage++; render(); });

  render();
})();
</script>
