---
import fs from 'node:fs';
import path from 'node:path';

interface Props {
  blog: {
    title: string;
    readMore: string;
    empty: string;
  };
  lang: string;
}

const { blog, lang } = Astro.props;

// Read blog posts from markdown files
function getBlogPosts(language: string) {
  const blogDir = path.join(process.cwd(), 'src', 'content', 'blog', language);
  
  if (!fs.existsSync(blogDir)) return [];
  
  const files = fs.readdirSync(blogDir).filter(f => f.endsWith('.md'));
  
  return files.map(file => {
    const content = fs.readFileSync(path.join(blogDir, file), 'utf-8');
    const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
    
    if (!frontmatterMatch) return null;
    
    const frontmatter = frontmatterMatch[1];
    const title = frontmatter.match(/title:\s*"(.+)"/)?.[1] || '';
    const date = frontmatter.match(/date:\s*"(.+)"/)?.[1] || '';
    const description = frontmatter.match(/description:\s*"(.+)"/)?.[1] || '';
    const tagsMatch = frontmatter.match(/tags:\s*\[(.+)\]/)?.[1] || '';
    const tags = tagsMatch.split(',').map(t => t.trim().replace(/"/g, '')).filter(Boolean);
    
    const slug = file.replace('.md', '');
    
    return { title, date, description, tags, slug };
  }).filter(Boolean).sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime());
}

const posts = getBlogPosts(lang);
---

<section id="blog" class="py-20 md:py-28 bg-sand-100/50 dark:bg-ink-900/30">
  <div class="max-w-5xl mx-auto px-6">
    <h2 class="section-heading observe-fade">{blog.title}</h2>

    {posts.length === 0 ? (
      <p class="text-ink-400 dark:text-sand-500 italic observe-fade">{blog.empty}</p>
    ) : (
      <div class="space-y-6">
        {posts.map((post: any) => (
          <a href={`/${lang}/blog/${post.slug}/`} class="card block group observe-fade">
            <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 mb-2">
              <h3 class="text-lg font-medium group-hover:text-sand-600 dark:group-hover:text-sand-400 transition-colors">{post.title}</h3>
              <span class="text-sm font-mono text-ink-400 dark:text-sand-500 shrink-0">{post.date}</span>
            </div>
            <p class="text-ink-600 dark:text-sand-300 text-sm leading-relaxed mb-3">{post.description}</p>
            <div class="flex items-center gap-4">
              <div class="flex gap-2">
                {post.tags.map((tag: string) => (
                  <span class="tag">{tag}</span>
                ))}
              </div>
              <span class="text-sm font-mono text-sand-500 group-hover:text-sand-700 dark:group-hover:text-sand-300 transition-colors ml-auto">
                {blog.readMore} â†’
              </span>
            </div>
          </a>
        ))}
      </div>
    )}
  </div>
</section>
